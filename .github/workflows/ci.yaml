# .github/workflows/ci.yaml
name: CI & Security

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 3.12
      - name: Install Dependencies
        run: uv sync --group dev
      - name: Check Formatting & Linting
        run: make check

  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv sync --group dev
      - name: Run Unit Tests
        run: make test

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv sync --group dev
      - name: Run Integration Tests
        run: make test-integration

  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    needs: quality
    env:
      CALANGO_HOME: ${{ github.workspace }}/test_run
      OPENAI_API_BASE: "http://localhost:8080" 
      OPENAI_API_KEY: "sk-mock"
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install 3.12
      - name: Install Dependencies
        run: |
          uv sync --group dev
          uv pip install flask
      - name: Install Playwright
        run: uv run playwright install --with-deps chromium
      - name: Run E2E Flow
        run: |
          mkdir -p $CALANGO_HOME
          # Start Mock SSE Server
          python -c "from flask import Flask, Response; app=Flask(__name__); @app.route('/chat/completions', methods=['POST']) def mock(): return Response('data: {\"choices\": [{\"delta\": {\"content\": \"Mock response\"}}], \"usage\": {\"prompt_tokens\": 5, \"completion_tokens\": 5}}\n\ndata: [DONE]\n\n', mimetype='text/event-stream'); app.run(port=8080)" &
          # Start App
          uv run streamlit run src/app.py --server.headless true &
          sleep 15
          make test-e2e

  security:
    name: ğŸ›¡ï¸ CVE Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv sync --group dev
      - name: Run Security Audit
        run: make security