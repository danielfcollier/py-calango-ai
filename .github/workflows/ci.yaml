# .github/workflows/ci.yaml
name: CI & Security

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  quality:
    name: üîç Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 3.12
      - name: Install Dependencies
        run: uv sync --group dev
      - name: Check Formatting & Linting
        run: make check

  unit-tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 3.12
      - name: Install Dependencies
        run: uv sync --group dev
      - name: Run Pytest (Unit)
        run: make test

  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 3.12
      - name: Install Dependencies
        run: uv sync --group dev
      - name: Run Pytest (Integration)
        run: make test-integration

        # .github/workflows/ci.yaml


  e2e-tests:
    name: üé≠ E2E Tests
    runs-on: ubuntu-latest
    needs: quality
    env:
      CALANGO_HOME: ${{ github.workspace }}/test_run
      OPENAI_API_BASE: "http://localhost:8080" 
      OPENAI_API_KEY: "sk-mock"
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      
      - name: Set up Python
        run: uv python install 3.12
        
      - name: Install Dependencies
        run: |
          uv sync --group dev
          uv pip install flask
        
      - name: Install Playwright Browsers
        run: uv run playwright install --with-deps chromium
        
      - name: Run E2E Tests
        run: |
          mkdir -p $CALANGO_HOME
          
          # 1. Start Mock Server
          python -c "from flask import Flask, Response; app=Flask(__name__); @app.route('/chat/completions', methods=['POST']) def mock(): return Response('data: {\"choices\": [{\"delta\": {\"content\": \"Mock response\"}}], \"usage\": {\"prompt_tokens\": 5, \"completion_tokens\": 5}}\n\ndata: [DONE]\n\n', mimetype='text/event-stream'); app.run(port=8080)" &
          
          # 2. Start Streamlit in background
          uv run streamlit run src/app.py --server.headless true &
          
          # 3. Wait for boot and run tests
          sleep 15
          make test-e2e

  security:
    name: üõ°Ô∏è CVE Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 3.12
      - name: Install Dependencies
        run: uv sync --group dev
      - name: Run pip-audit (CVE Scan)
        run: make security