### ðŸ” Phase 6: Identity & Control - Execution Plan

**Before you begin:**

1. Run `pip install streamlit-authenticator bcrypt`.
2. Ensure you have completed Phase 4 (SQLAlchemy), as this relies on the `User` model.

---

#### ðŸ”¹ Prompt 1: Identity Infrastructure (Models & Services)

*First, we define who the users are and how much they can spend.*

> **Context:**
> I am implementing Authentication and Quota management for "Calango AI". I need to update my database schema and create services to manage users.
> **Goal:**
> Update the ORM models and create `AuthService` and `QuotaService`.
> **Requirements:**
> 1. **Update `src/calango/db/models.py**`:
> * Add **Model `User**`:
> * `id` (UUID, PK)
> * `username` (Unique, String)
> * `password_hash` (String)
> * `role` (String: 'admin', 'user')
> * `token_balance` (Integer, default=100000)
> * `monthly_limit` (Integer, default=1000000)
> 
> 
> * Update `ChatSession`: Add `user_id` (ForeignKey to `User`).
> 
> 
> 2. **Update `src/calango/db/repositories.py**`:
> * Add `UserRepository`: `get_by_username`, `create_user`, `update_balance`.
> 
> 
> 3. **Create `src/calango/services/auth_service.py**`:
> * `authenticate(username, password)`: Verify hash (using `bcrypt`).
> * `register(username, password)`: Hash password and save.
> 
> 
> 4. **Create `src/calango/services/quota_service.py**`:
> * `check_availability(user_id, estimated_cost)`: Returns True/False.
> * `deduct_tokens(user_id, amount)`: Updates the `token_balance`.
> 
> 
> 
> 
> Please generate the code updates for `models.py`, `repositories.py`, and the new service files.

---

#### ðŸ”¹ Prompt 2: The Login Gate (UI & Middleware)

*Now we secure the application entry point.*

> **Context:**
> I have the backend for Users ready. Now I need to protect the Streamlit app so only logged-in users can access it. I want to support a "Desktop Mode" (auto-login) and "Server Mode" (require password).
> **Goal:**
> Create a Login UI and integrate it into `src/app.py`.
> **Requirements:**
> 1. **Create `src/ui/login.py**`:
> * Function `render_login()`:
> * Use `streamlit-authenticator` or a simple form (username/password).
> * Call `AuthService.authenticate`.
> * If successful, set `st.session_state["authenticated"] = True` and store `st.session_state["user"]` object.
> 
> 
> 
> 
> 2. **Refactor `src/app.py**`:
> * **Check Environment**: If `os.getenv("CALANGO_MODE") == "DESKTOP"`, automatically log in as a default "Local User" (create if not exists).
> * **Main Flow**:
> * If `st.session_state["authenticated"]` is False:
> * Show `render_login()`.
> * Stop execution (`st.stop()`).
> 
> 
> * If True:
> * Show the Navigation (`pg.run()`).
> * Show "Welcome, {username}" and "Balance: {tokens}" in the Sidebar.
> * Add a "Logout" button in the sidebar.
> 
> 
> 
> 
> 
> 
> 
> 
> Please generate the code for `src/ui/login.py` and the updated `src/app.py`.

---

#### ðŸ”¹ Prompt 3: The Budget Enforcer (Quota Logic)

*Finally, we stop users from spending more than they have.*

> **Context:**
> I have users and quotas, but the Chat and Rinha services ignore them. I need to enforce limits.
> **Goal:**
> Update `ChatService` and `ArenaService` to respect user quotas.
> **Requirements:**
> 1. **Update `src/calango/services/chat_service.py**`:
> * Inject `QuotaService` and `current_user` into the service (or pass `user` to `send_message`).
> * **Before Generation**: Call `quota_service.check_availability(user.id, estimate=0)`.
> * If False, raise `QuotaExceededException("You ran out of tokens!")`.
> 
> 
> * **After Generation**: Calculate actual usage and call `quota_service.deduct_tokens(user.id, total_tokens)`.
> 
> 
> 2. **Update `src/calango/services/arena_service.py**`:
> * Apply similar logic to `run_battle_round`.
> 
> 
> 3. **Update UI (`src/ui/home.py`, `src/ui/rinha.py`)**:
> * Wrap the `send_message` call in a `try...except QuotaExceededException`.
> * If caught, show `st.error("ðŸš« Saldo insuficiente! Recarregue seus tokens.")`.
> 
> 
> 
> 
> Please generate the updated code for the services and the UI error handling.